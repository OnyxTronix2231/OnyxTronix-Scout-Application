@using System.Timers
@using System.Diagnostics
@using System.Diagnostics.CodeAnalysis
@using System.Globalization
@inherits InputBase<float?>

@if (FormType == FormType.Create)
{
    <div>
        <SfButton type="button" @onclick="StartCount">Start count</SfButton>
    </div>
    <br>
    <div>
        <label>@currentTimeSpan?.ToString(@"mm\:ss\.fff")</label>
        @if (AllowManualInput)
        {
            <SfTimePicker TValue="TimeSpan?" Format="mm\:ss\.fff" Value="@currentTimeSpan">
                <TimePickerEvents TValue="TimeSpan?" ValueChange="@TimeSpanChanged"> </TimePickerEvents>
             </SfTimePicker>
        }
        <ValidationMessage For="() => ValueExpression"></ValidationMessage>
    </div>
    <br>
    <div>
        <SfButton type="button" @onclick="StopCount">Stop count</SfButton>
        <SfButton type="button" @onclick="ResetCountAndUpdate">Reset count</SfButton>
    </div>
}
else
{
    <div>
        <label>@currentTimeSpan?.ToString(@"mm\:ss\.fff")</label>
        @if(FormType != FormType.View) 
        {
            <SfTimePicker TValue="TimeSpan?" Format="mm\:ss\.fff" Value="@currentTimeSpan">
                <TimePickerEvents TValue="TimeSpan?" ValueChange="@TimeSpanChanged"> </TimePickerEvents>
            </SfTimePicker>
        }
    </div>
    
}


@code {

    [Parameter]
    public FormType FormType { get; set; }
    [Parameter]
    public bool AllowManualInput { get; set; }

    private SfTimePicker<TimeSpan?> timePicker;
    private TimeSpan? currentTimeSpan;

    private Timer timer;
    private Stopwatch stopwatch;

    protected override void OnInitialized()
    {
        timer = new Timer(100);
        stopwatch = new Stopwatch();
        if (CurrentValue != null)
        {
            currentTimeSpan = TimeSpan.FromSeconds(CurrentValue.Value);
        }
        timer.Elapsed += (sender, args) => { UpdateCurrentTime(); };
    }

    private void StartCount()
    {
        timer.Start();
        stopwatch.Start();
    }

    private void StopCount()
    {
        timer.Stop();
        stopwatch.Stop();
        UpdateCurrentTime();
    }

    private void ResetCount()
    {
        timer.Stop();
        stopwatch.Reset();
    }
    
    private void ResetCountAndUpdate()
    {
        ResetCount();
        UpdateCurrentTime();
    }

    private void UpdateCurrentTime()
    {
        currentTimeSpan = stopwatch.Elapsed;
        CurrentValue = (float) stopwatch.Elapsed.TotalSeconds;
        Console.WriteLine(CurrentValue);
        StateHasChanged();
    }

    private void TimeSpanChanged(Syncfusion.Blazor.Calendars.ChangeEventArgs<TimeSpan?> args)
    {
        currentTimeSpan = args.Value;
        StateHasChanged();
        if (currentTimeSpan != null)
        {
            CurrentValue = (float) currentTimeSpan.Value.TotalSeconds;
            return;
        }
        CurrentValue = null;
    }

    protected override bool TryParseValueFromString(string value, out float? result, [NotNullWhen(false)] out string validationErrorMessage)
    {
        validationErrorMessage = null;
        if (string.IsNullOrWhiteSpace(value))
        {
            result = null;
            return true;
        }
        bool success = float.TryParse(value, out float val);
        if (!success)
        {
            validationErrorMessage = "Value has to be a number";
        }
        result = val;
        return success;
    }

}
