@using Microsoft.JSInterop;
@using OnyxScoutApplication.Shared.Models.ScoutFormModels
@using Action = System.Action

@inherits LayoutComponentBase
@inject NotificationManager notificationManager
@inject NavigationManager navigationManager
@inject HttpClientManager http
@inject ISyncLocalStorageService localStorage
@inject ISyncSessionStorageService sessionStorage
@inject IJSRuntime jsRuntime

<div class="page">
    <div class="sidebar">
        <NavMenu/>
    </div>
    <Toast></Toast>

    <div class="main">
        <div class="top-row px-4 auth">
            <LoginDisplay/>
            <span>V2.1.1</span>
        </div>
        <div class="content px-4">
            @if (finishedInit)
            {
                @Body
            }
        </div>
    </div>
</div>

@code{
    bool finishedInit;

    protected override async Task OnInitializedAsync()
    {
        await jsRuntime
            .InvokeAsync<object>(
                "blazorFuncs.registerClient",
                new object[] {DotNetObjectReference.Create(this)}
            );

        if (localStorage.ContainKey("EventSelector/SelectedEventKey"))
        {
            Event selectedEvent = localStorage.GetItem<Event>("EventSelector/SelectedEventKey");
            var matches = await http.GetJson<List<Match>>("TheBlueAlliance/GetAllMatches/" + selectedEvent.Key);
            sessionStorage.SetItem("TheBlueAlliance.AllMatches", matches);

            var scoutForms = await http.GetJson<List<FormDto>>("ScoutForm/GetAllByEvent/" + selectedEvent.Key);
            sessionStorage.SetItem("ScoutForms.All", scoutForms);

            var events = await http.GetJson<List<Event>>("TheBlueAlliance/GetAllEvents/" + selectedEvent.Year);
            if (events != null) //user is probably not authorized 
            {
                events = events.Where(i => string.Equals(i.Country, selectedEvent.Country,
                    StringComparison.OrdinalIgnoreCase)).OrderBy(i => i.StartDate).ToList();
                sessionStorage.SetItem("TheBlueAlliance.AllEvents", events);
            }
            
            var teams = await http.GetJson<List<Team>>("TheBlueAlliance/GetAllTeams/" + selectedEvent.Key);
            sessionStorage.SetItem("TheBlueAlliance.AllTeams", teams);
        }
        finishedInit = true;
    }

    [JSInvokable("onUpdateAvailable")]
    public async Task<string> AppUpdate()
    {
        Console.WriteLine("New version available");
        StateHasChanged();
        await notificationManager.NotifyAsync("Update available", "Please refresh the page", NotificationType.Warning, 
            0, new NotficationButton { Content = "Refresh", Action = RefreshPage });
        return await Task.FromResult("Alerted client");
    }

    private void RefreshPage(object arg)
    {
        navigationManager.NavigateTo("/", true);
    }

}
